name: Coverage Report

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      OPAMYES: "true"
      OPAMROOT: /home/opam/.opam
      MIAOU_GIT_URL: ${{ secrets.MIAOU_GIT_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for coverage comparison

      - name: Cache opam packages
        id: cache-opam
        uses: actions/cache@v4
        with:
          path: /home/opam/.opam
          key: opam-miaou-${{ hashFiles('.github/miaou-version') }}
          restore-keys: |
            opam-miaou-

      - name: Pin miaou packages
        if: steps.cache-opam.outputs.cache-hit != 'true'
        run: |
          if [ -z "$MIAOU_GIT_URL" ]; then
            echo "ERROR: MIAOU_GIT_URL secret is not configured." >&2
            exit 1
          fi
          opam pin add miaou-core "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-driver-term "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-driver-matrix "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-runner "$MIAOU_GIT_URL" --no-action
          opam install miaou-core miaou-driver-term miaou-driver-matrix miaou-runner eio_posix

      - name: Run unit tests with coverage
        run: |
          mkdir -p _coverage
          export BISECT_FILE=$PWD/_coverage/bisect-unit
          dune clean
          dune runtest --instrument-with bisect_ppx --force
        continue-on-error: false

      - name: Upload unit coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: _coverage/
          retention-days: 1

  build-instrumented-binary:
    name: Build Instrumented Binary (Debian)
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    env:
      DEBIAN_FRONTEND: noninteractive
    
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            opam \
            build-essential \
            git \
            ca-certificates \
            libgmp-dev \
            m4 \
            pkg-config \
            curl
      
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Initialize opam
        run: |
          opam init --disable-sandboxing --bare -y
          opam switch create . ocaml.5.1.1 -y
          eval $(opam env)
      
      - name: Install OCaml dependencies
        run: |
          eval $(opam env)
          opam install -y \
            dune \
            cmdliner \
            rresult \
            yojson \
            bos \
            eio \
            eio_main \
            eio_posix \
            cohttp-eio \
            tls-eio \
            ca-certs \
            uri \
            lambda-term \
            linenoise \
            ppx_deriving \
            alcotest \
            bisect_ppx
      
      - name: Install Miaou
        run: |
          eval $(opam env)
          if [ -z "${{ secrets.MIAOU_GIT_URL }}" ]; then
            echo "ERROR: MIAOU_GIT_URL secret not configured" >&2
            exit 1
          fi
          opam pin add miaou-core "${{ secrets.MIAOU_GIT_URL }}" --no-action -y
          opam pin add miaou-driver-term "${{ secrets.MIAOU_GIT_URL }}" --no-action -y
          opam pin add miaou-driver-matrix "${{ secrets.MIAOU_GIT_URL }}" --no-action -y
          opam pin add miaou-runner "${{ secrets.MIAOU_GIT_URL }}" --no-action -y
          opam install miaou-core miaou-driver-term miaou-driver-matrix miaou-runner -y
      
      - name: Build instrumented binary
        run: |
          eval $(opam env)
          dune clean
          dune build --instrument-with bisect_ppx --release
          cp _build/default/src/main.exe octez-manager-instrumented
          chmod +x octez-manager-instrumented
      
      - name: Upload instrumented binary
        uses: actions/upload-artifact@v4
        with:
          name: octez-manager-coverage
          path: octez-manager-instrumented
          retention-days: 1

  integration-coverage:
    name: Integration Tests Coverage
    runs-on: ubuntu-latest
    needs: [coverage, build-instrumented-binary]
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download instrumented binary
        uses: actions/download-artifact@v4
        with:
          name: octez-manager-coverage
          path: .

      - name: Copy binary to test location
        run: |
          mkdir -p test/integration/cli-tester
          cp octez-manager-instrumented test/integration/cli-tester/octez-manager
          chmod +x test/integration/cli-tester/octez-manager

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build coverage test containers
        working-directory: test/integration
        run: |
          docker compose -f docker-compose.yml -f docker-compose.coverage.yml build

      - name: Start sandbox
        working-directory: test/integration
        run: |
          docker compose -f docker-compose.yml -f docker-compose.coverage.yml up -d sandbox
          timeout 300 bash -c 'until docker compose exec -T sandbox curl -sf http://localhost:8080/health 2>/dev/null; do echo "Waiting for sandbox..."; sleep 10; done'

      - name: Start cli-tester with coverage
        working-directory: test/integration
        run: |
          docker compose -f docker-compose.yml -f docker-compose.coverage.yml up -d cli-tester
          echo "Waiting for systemd..."
          for i in {1..30}; do
            if docker compose exec -T cli-tester systemctl is-system-running 2>/dev/null; then
              echo "Systemd is ready"
              break
            fi
            echo "Attempt $i: systemd not ready yet..."
            sleep 2
          done
          docker compose ps

      - name: Run integration tests with coverage
        working-directory: test/integration
        run: |
          docker compose -f docker-compose.yml -f docker-compose.coverage.yml exec -T cli-tester /run-tests.sh

      - name: Extract coverage data from container
        working-directory: test/integration
        run: |
          mkdir -p ../../_coverage-integration
          docker compose -f docker-compose.yml -f docker-compose.coverage.yml cp cli-tester:/coverage/. ../../_coverage-integration/ || true
          ls -la ../../_coverage-integration/

      - name: Upload integration coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: _coverage-integration/
          retention-days: 1

      - name: Cleanup containers
        if: always()
        working-directory: test/integration
        run: |
          docker compose -f docker-compose.yml -f docker-compose.coverage.yml down -v || true

  report:
    name: Generate and Post Coverage Report
    runs-on: ubuntu-latest
    needs: [coverage, build-instrumented-binary, integration-coverage]
    container:
      image: ghcr.io/${{ github.repository }}-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      OPAMYES: "true"
      OPAMROOT: /home/opam/.opam

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install bisect_ppx
        run: opam install bisect_ppx

      - name: Download unit coverage data
        uses: actions/download-artifact@v4
        with:
          name: coverage-unit
          path: _coverage/

      - name: Download integration coverage data
        uses: actions/download-artifact@v4
        with:
          name: coverage-integration
          path: _coverage/
        continue-on-error: true

      - name: List all coverage files
        run: |
          echo "Coverage files found:"
          find _coverage -name "*.coverage" -ls || echo "No coverage files found"

      - name: Generate coverage report
        run: |
          mkdir -p coverage-report
          
          # Generate summary
          echo "## Coverage Report" > coverage-summary.md
          echo "" >> coverage-summary.md
          
          bisect-ppx-report summary \
            --coverage-path _coverage > coverage-summary.txt || echo "Summary generation failed"
          
          cat coverage-summary.txt >> coverage-summary.md
          
          # Generate HTML report
          bisect-ppx-report html \
            --coverage-path _coverage \
            --title "Octez Manager Coverage" \
            -o coverage-report || echo "HTML generation failed"
          
          # Generate per-file summary
          echo "" >> coverage-summary.md
          echo "### Coverage by File" >> coverage-summary.md
          echo "" >> coverage-summary.md
          echo '```' >> coverage-summary.md
          bisect-ppx-report summary \
            --coverage-path _coverage \
            --per-file >> coverage-summary.md || echo "Per-file summary failed"
          echo '```' >> coverage-summary.md
          
          # Extract overall percentage
          COVERAGE_PCT=$(grep -oP 'Coverage: \K[0-9.]+' coverage-summary.txt || echo "0")
          echo "COVERAGE_PCT=$COVERAGE_PCT" >> $GITHUB_ENV
          echo "Overall coverage: $COVERAGE_PCT%"

      - name: Get base branch coverage (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          # Try to get base coverage from previous runs
          # For now, we'll store it in the summary
          echo "BASE_COVERAGE=0" >> $GITHUB_ENV
        continue-on-error: true

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = process.env.COVERAGE_PCT || '0';
            const baseCoverage = process.env.BASE_COVERAGE || '0';
            const diff = (parseFloat(coverage) - parseFloat(baseCoverage)).toFixed(2);
            
            let emoji = 'üìä';
            let diffText = '';
            let diffColor = '';
            
            if (diff > 0) {
              emoji = 'üìà';
              diffText = `(+${diff}%)`;
              diffColor = 'üü¢';
            } else if (diff < 0) {
              emoji = 'üìâ';
              diffText = `(${diff}%)`;
              diffColor = 'üî¥';
            } else {
              diffText = '(no change)';
              diffColor = '‚ö™';
            }
            
            let summary = '';
            try {
              summary = fs.readFileSync('coverage-summary.md', 'utf8');
            } catch (e) {
              summary = 'Coverage report not available';
            }
            
            const comment = `## ${emoji} Coverage Report
            
            **Overall Coverage:** ${coverage}% ${diffColor} ${diffText}
            
            ${summary}
            
            <details>
            <summary>‚ÑπÔ∏è Coverage Details</summary>
            
            - **Unit Tests:** ‚úÖ Instrumented with bisect_ppx
            - **Integration Tests:** ‚úÖ Instrumented with bisect_ppx
            - **Report Type:** Combined coverage from both test suites
            
            </details>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Coverage Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report/
          retention-days: 30

      - name: Coverage check
        run: |
          COVERAGE_PCT=$(grep -oP 'Coverage: \K[0-9.]+' coverage-summary.txt || echo "0")
          echo "Coverage: $COVERAGE_PCT%"
          
          # Fail if coverage drops below threshold (optional)
          # THRESHOLD=50
          # if (( $(echo "$COVERAGE_PCT < $THRESHOLD" | bc -l) )); then
          #   echo "ERROR: Coverage $COVERAGE_PCT% is below threshold $THRESHOLD%"
          #   exit 1
          # fi
