name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '**/*.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '**/*.md'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/${{ github.repository }}-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      OPAMYES: "true"
      OPAMROOT: /home/opam/.opam
      MIAOU_GIT_URL: ${{ secrets.MIAOU_GIT_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache opam packages
        id: cache-opam
        uses: actions/cache@v4
        with:
          path: /home/opam/.opam
          key: opam-miaou-${{ hashFiles('.github/miaou-version') }}
          restore-keys: |
            opam-miaou-

      - name: Pin miaou packages
        if: steps.cache-opam.outputs.cache-hit != 'true'
        run: |
          if [ -z "$MIAOU_GIT_URL" ]; then
            echo "ERROR: MIAOU_GIT_URL secret is not configured." >&2
            exit 1
          fi
          opam pin add miaou-core "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-driver-term "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-driver-matrix "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-runner "$MIAOU_GIT_URL" --no-action
          opam install miaou-core miaou-driver-term miaou-driver-matrix miaou-runner eio_posix

      - name: Cache dune build
        uses: actions/cache@v4
        with:
          path: _build
          key: dune-${{ runner.os }}-${{ hashFiles('**/*.ml', '**/*.mli', '**/dune', '**/dune-project') }}
          restore-keys: |
            dune-${{ runner.os }}-

      - name: Build
        run: |
          echo '(-ccopt -static)' > static_flags.sexp
          dune build --release

      - name: Test
        run: |
          chown -R opam:opam /home/opam/.opam
          chown -R opam:opam .
          su -s /bin/sh opam -c "git checkout -- static_flags.sexp && make test"

      - name: Prepare binary artifact
        run: |
          mkdir -p artifacts
          cp _build/default/src/main.exe artifacts/octez-manager
          chmod +x artifacts/octez-manager

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: octez-manager-static
          path: artifacts/octez-manager
          retention-days: 1

  integration-tests:
    name: Integration Tests (${{ matrix.category }})
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        category: [node, dal, baker, accuser]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download static binary
        uses: actions/download-artifact@v4
        with:
          name: octez-manager-static
          path: test/integration/cli-tester/

      - name: Prepare test binary
        run: |
          chmod +x test/integration/cli-tester/octez-manager

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Build and start containers
        working-directory: test/integration
        env:
          DOCKER_BUILDKIT: 1
        run: |
          # Build with cache and start
          docker compose up -d --build

          # Wait for sandbox to be healthy
          echo "Waiting for sandbox..."
          timeout 300 bash -c 'until docker compose exec -T sandbox curl -sf http://localhost:8080/health 2>/dev/null; do sleep 5; done'
          echo "Sandbox is ready"

          # Wait for systemd to be ready
          echo "Waiting for systemd..."
          for i in {1..30}; do
            if docker compose exec -T cli-tester systemctl is-system-running 2>/dev/null; then
              echo "Systemd is ready"
              break
            fi
            sleep 2
          done

      - name: Run integration tests (${{ matrix.category }})
        working-directory: test/integration
        run: |
          docker compose exec -T cli-tester /run-tests.sh ${{ matrix.category }}

      - name: Collect logs on failure
        if: failure()
        working-directory: test/integration
        run: |
          echo "=== Sandbox logs ==="
          docker compose logs sandbox || true
          echo "=== CLI-tester logs ==="
          docker compose logs cli-tester || true

      - name: Cleanup
        if: always()
        working-directory: test/integration
        run: |
          docker compose down -v || true

  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build-and-test
    permissions:
      contents: write
    container:
      image: ghcr.io/${{ github.repository }}-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    env:
      OPAMYES: "true"
      OPAMROOT: /home/opam/.opam
      MIAOU_GIT_URL: ${{ secrets.MIAOU_GIT_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache opam packages
        id: cache-opam
        uses: actions/cache@v4
        with:
          path: /home/opam/.opam
          key: opam-miaou-${{ hashFiles('.github/miaou-version') }}
          restore-keys: |
            opam-miaou-

      - name: Pin miaou packages
        if: steps.cache-opam.outputs.cache-hit != 'true'
        run: |
          opam pin add miaou-core "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-driver-term "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-driver-matrix "$MIAOU_GIT_URL" --no-action
          opam pin add miaou-runner "$MIAOU_GIT_URL" --no-action
          opam install miaou-core miaou-driver-term miaou-driver-matrix miaou-runner eio_posix

      - name: Build static binary
        run: |
          echo '(-ccopt -static)' > static_flags.sexp
          dune build --release

      - name: Prepare release artifact
        run: |
          mkdir -p release
          cp _build/default/src/main.exe release/octez-manager-${{ github.ref_name }}-linux-x86_64
          chmod +x release/octez-manager-${{ github.ref_name }}-linux-x86_64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/octez-manager-${{ github.ref_name }}-linux-x86_64
          generate_release_notes: true
