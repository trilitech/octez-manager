# CI build image for octez-manager
# Contains OCaml, opam, and all public dependencies pre-installed
# Miaou is pinned at CI runtime (private repo)

FROM ocaml/opam:alpine-ocaml-5.1 AS base

# Switch to root for system package installation
USER root

# Install system dependencies for static linking
RUN apk add --no-cache \
    zlib-dev \
    zlib-static \
    gmp-dev \
    gmp-static \
    libffi-dev \
    libffi-static \
    git \
    m4 \
    make \
    patch \
    gcc \
    musl-dev

# Switch back to opam user
USER opam
WORKDIR /home/opam

# Update opam and install common dependencies that won't change often
RUN opam update && opam install -y \
    dune \
    cmdliner \
    rresult \
    yojson \
    bos \
    eio \
    eio_main \
    cohttp-eio \
    tls-eio \
    tls \
    ca-certs \
    domain-name \
    mirage-crypto-rng \
    uri \
    lambda-term \
    linenoise \
    ppx_deriving \
    alcotest

# Clean up opam cache to reduce image size
RUN opam clean -a -c -s --logs

# GitHub Actions runs containers as root by default
# Initialize opam for root user, pointing to the existing switch
USER root
RUN mkdir -p /root/.opam && \
    cp -r /home/opam/.opam/config /root/.opam/ && \
    ln -s /home/opam/.opam/5.1 /root/.opam/5.1 && \
    ln -s /home/opam/.opam/repo /root/.opam/repo && \
    ln -s /home/opam/.opam/download-cache /root/.opam/download-cache && \
    opam switch set 5.1

ENV OPAM_SWITCH_PREFIX=/home/opam/.opam/5.1
ENV CAML_LD_LIBRARY_PATH=/home/opam/.opam/5.1/lib/stublibs:/home/opam/.opam/5.1/lib/ocaml/stublibs:/home/opam/.opam/5.1/lib/ocaml
ENV OCAML_TOPLEVEL_PATH=/home/opam/.opam/5.1/lib/toplevel
ENV PATH=/home/opam/.opam/5.1/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
WORKDIR /github/workspace
# trigger rebuild
